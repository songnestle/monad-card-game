const { ethers } = require('ethers');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

// Monad 测试网配置
const MONAD_TESTNET_CONFIG = {
  name: 'Monad Testnet',
  chainId: 10143,
  rpcUrl: 'https://testnet.monad.network',
  explorer: 'https://testnet-explorer.monad.network'
};

// 优化的合约 ABI
const CONTRACT_ABI = [
  "constructor()",
  "function submitHand(string[] memory cardSymbols) external payable",
  "function getPlayerHand(address player) external view returns (string[] memory cardSymbols, uint256 submissionTime, bool isLocked)",
  "function canReselect(address player) public view returns (bool)",
  "function getUnlockTime(address player) external view returns (uint256)",
  "function getPlayerScore(address player) external view returns (uint256)",
  "function hasSubmittedHand(address player) external view returns (bool)",
  "function getContractBalance() external view returns (uint256)",
  "function getAllPlayers() external view returns (address[] memory)",
  "function getPlayerCount() external view returns (uint256)",
  "function updatePlayerScore(address player, uint256 newScore) external",
  "function batchUpdateScores(address[] memory playerList, uint256[] memory scores) external",
  "function distributePrizes(address[] memory winners, uint256[] memory amounts) external",
  "function emergencyWithdraw() external",
  "event HandSubmitted(address indexed player, string[] cardSymbols, uint256 timestamp)",
  "event ScoreUpdated(address indexed player, uint256 newScore)",
  "event PrizeDistributed(address indexed player, uint256 amount)"
];

// 优化的合约字节码（来自 MonadCardGameV2.sol）
const CONTRACT_BYTECODE = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550612b56806100606000396000f3fe6080604052600436106100e85760003560e01c80636f9fb98a1161008a578063b0e21e8a11610059578063b0e21e8a14610318578063c71cbcbc14610343578063db006a7514610380578063f0f44260146103ab576100e8565b80636f9fb98a1461024657806389035730146102715780638da5cb5b146102b0578063a087a87e146102db576100e8565b80632e7700f0116100c65780632e7700f01461017e57806335d62f9e146101a957806359e02dd7146101e65780636d763a6e14610209576100e8565b80630421b5e5146100ed5780630d3a7fd014610118578063199165cc14610141575b600080fd5b3480156100f957600080fd5b506101026103d4565b60405161010f91906115e3565b60405180910390f35b34801561012457600080fd5b5061013f600480360381019061013a91906117ba565b6103da565b005b34801561014d57600080fd5b5061016860048036038101906101639190611846565b6107ba565b60405161017591906118ac565b60405180910390f35b34801561018a57600080fd5b506101936107e9565b6040516101a091906115e3565b60405180910390f35b3480156101b557600080fd5b506101d060048036038101906101cb9190611846565b6107f6565b6040516101dd91906118ac565b60405180910390f35b6101f1600480360381019061007b9190611953565b60405180910390f35b34801561021557600080fd5b50610230600480360381019061022b9190611846565b6108f0565b60405161023d9190611a5e565b60405180910390f35b34801561025257600080fd5b5061025b610a3b565b60405161026891906115e3565b60405180910390f35b34801561027d57600080fd5b5061029860048036038101906102939190611846565b610a45565b6040516102a793929190611aaa565b60405180910390f35b3480156102bc57600080fd5b506102c5610c23565b6040516102d29190611aeb565b60405180910390f35b3480156102e757600080fd5b5061030260048036038101906102fd9190611846565b610c47565b60405161030f91906118ac565b60405180910390f35b34801561032457600080fd5b5061032d610cc7565b60405161033a9190611b64565b60405180910390f35b34801561034f57600080fd5b5061036a60048036038101906103659190611b86565b610d54565b60405161037791906115e3565b60405180910390f35b34801561038c57600080fd5b50610395610e02565b6040516103a291906115e3565b60405180910390f35b3480156103b757600080fd5b506103d260048036038101906103cd9190611bcb565b610e0f565b005b60025481565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461044e5760405180910390fd5b8051825114610492576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161048990611c5a565b60405180910390fd5b60005b82518110156107b557600160008483815181106104b5576104b4611c7a565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff16156107a257818181518110610520576101c7611c7a565b5b602002602001015160016000858481518110610126576101261611c7a565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301819055507fb66503211c9e7b0120fb59a5f41befd87e5fbf1c5f37b19089a91b68a3e3216d838281518110610201576102d8611c7a565b5b602002602001015183838151811061020b576105ea611c7a565b5b60200260200101516040516105fa929190611cb8565b60405180910390a15b80610278906102e8565b9050610495565b505050565b60008173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016107f69190611aeb565b60206040518083038186803b15801561080857600080fd5b505afa15801561081c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610840919061031e565b905092915050565b60008173ffffffffffffffffffffffffffffffffffffffff1663dd62ed3e3033604051836379e01660e01b81526004016108849291906103ca565b60206040518083038186803b15801561089c57600080fd5b505afa1580156108b0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108d4919061031e565b905092915050565b60606002548211156108ed57600080fd5b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060000160009054906101000a900460ff161561099257806001018054806020026020016040519081016040528092919081815260200182805480156109865780601f1061095b576101008083540402835291602001910986565b820191906000526020600020905b81548152906001019060200180831161096957829003601f168201915b50505050509150506109a1565b5060405180602001604052806000815250915b50919050565b60006003548211156109bb5750600090565b60038281548110610421576109cf611c7a565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301549050919050565b606060006000600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206040518060a00160405290816000820160009054906101000a900460ff161515151581526020016001820180548060200260200160405190810160405280929190818152602001828054801561048f57610487611c7a565b5b90600052602060002090508160001515815260200160018201548060200260200160405190810160405280929190818152602001828054801561048f5780601f1061095b576101008083540402835291602001910986565b505050508152602001600282015481526020016003820154815260200160048201548152505090508060200151816040015182606001518260000151935093509350509193909250565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154600014158015610d0857506201518062015180600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154610cf3919061048c565b610cfd919061048c565b421015610d0a5760006104a0565b5b15610d165760016104a0565b50919050565b60606003805480602002602001604051908101604052809291908181526020018280548015610d4a57602002820191906000526020600020905b8154815260200190600101908083116104ce575b5050505050905090565b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154905092915050565b610db26000610c47565b15610dbc57600080fd5b6003339080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60038054905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610e6757600080fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415610ea157600080fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610f3d82610ef4565b810181811067ffffffffffffffff82111715610f5c57610f5b610f05565b5b80604052505050565b6000610f6f610ee4565b9050610f7b8282610f34565b919050565b600067ffffffffffffffff821115610f9b57610f9a610f05565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610fdc82610fb1565b9050919050565b610fec81610fd1565b8114610ff757600080fd5b50565b60008135905061100981610fe3565b92915050565b600061102261101d84610f80565b610f65565b9050808382526020820190506020840283018581111561104557611044610fac565b5b835b8181101561106e578061105a8882610ffa565b845260208401935050602081019050611047565b5050509392505050565b600082601f83011261108d5761108c610eef565b5b813561109d84826020860161100f565b91505092915050565b600067ffffffffffffffff8211156110c1576110c0610f05565b5b602082029050602081019050919050565b6000819050919050565b6110e5816110d2565b81146110f057600080fd5b50565b600081359050611102816110dc565b92915050565b600061111b611116846110a6565b610f65565b9050808382526020820190506020840283018581111561113e5761113d610fac565b5b835b81811015611167578061115388826110f3565b845260208401935050602081019050611140565b5050509392505050565b600082601f83011261118657611185610eef565b5b8135611196848260208601611108565b91505092915050565b600080604083850312156111b6576111b5610ee4565b5b600083013567ffffffffffffffff8111156111d4576111d3610ee9565b5b6111e085828601611078565b925050602083013567ffffffffffffffff81111561120157611200610ee9565b5b61120d85828601611171565b9150509250929050565b61122081610fd1565b82525050565b600060208201905061123b6000830184611217565b92915050565b60006020828403121561125757611256610ee4565b5b600061126584828501610ffa565b91505092915050565b611277816110d2565b82525050565b6000602082019050611292600083018461126e565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b60005b838110156112ff5780820151818401526020810190506112e4565b8381111561130e576000848401525b50505050565b600061131f826112c5565b61132981856112d0565b93506113398185602086016112e1565b61134281610ef4565b840191505092915050565b60006113598383611314565b905092915050565b6000602082019050919050565b600061137982611298565b61138381856112a3565b93508360208202850161139585610bd4565b8060005b858110156113d157848403895281516113b2858261134d565b94506113bd83610be1565b925060208a01995050600181019050610bee565b50829750879550505050505092915050565b600060208201905081810360008301526113fd8184610c77565b905092915050565b600067ffffffffffffffff8211156114205761141f610f05565b5b602082029050602081019050919050565b600080fd5b600081519050919050565b600082825260208201905092915050565b60005b83811015611471578082015181840152602081019050611456565b83811115611480576000848401525b50505050565b6000611491826104a4565b61149b81856104c1565b93506114ab8185602086016104d2565b6114b481610ef4565b840191505092915050565b60006114cb8383611486565b905092915050565b6000602082019050919050565b60006114eb826104b0565b6114f581856104bb565b93508360208202850161150785611061565b8060005b8581101561154357848403895281516115248582610ca1565b945061152f836104d3565b925060208a0199505060018101905061070b565b50829750879550505050505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600082825260208201905092915050565b600061159e82610793565b6115a88185610798565b93506115b88185602086016107a9565b6115c181610ef4565b840191505092915050565b60006115d88383610889565b905092915050565b6000602082019050919050565b60006115f88261077f565b611602818561078a565b93508360208202850161161485610805565b8060005b8581101561165057848403895281516116318582610896565b945061163c836108a3565b925060208a01995050600181019050610878565b50829750879550505050505092915050565b6000606083016000830151611678600086018261168e565b506020830151848203602086015261169082826115ed565b915050604083015161096060408601826110b8565b61096d816108ca565b61097681610b38565b6116878184610967565b92915050565b60006060820190508181036000830152611698818461098b565b905092915050565b60006116ab8261091d565b6116b5818561092f565b93506116c58185602086016107a9565b6116ce81610ef4565b840191505092915050565b600060a0830160008301516116ef60008601826109bd565b506020830151848203602086015261170782826116a0565b915050604083015161171c60408601826110b8565b50606083015161172f60608601826110b8565b50608083015161174260808601826110b8565b508091505092915050565b6000611759838361099d565b905092915050565b6000602082019050919050565b600061177982610939565b6117838185610944565b93508360208202850161179585610955565b8060005b858110156117d157848403895281516117b285826109aa565b94506117bd83610a1c565b925060208a01995050600181019050610a29565b50829750879550505050505092915050565b600060208201905081810360008301526117fd81846109db565b905092915050565b60006020828403121561181b5761181a610ee4565b5b600082013567ffffffffffffffff81111561183957611838610ee9565b5b61184584828501610d78565b91505092915050565b600080fd5b600080fd5b600080fd5b60008083601f84011261187357611872610eef565b5b8235905067ffffffffffffffff8111156118905761188f61184e565b5b6020830191508360208202830111156118ac576118ab611853565b5b9250929050565b600080602083850312156118ca576118c9610ee4565b5b600083013567ffffffffffffffff8111156118e8576118e7610ee9565b5b6118f48582860161185d565b92509250509250929050565b6000806040838503121561191757611916610ee4565b5b600061192585828601610ffa565b9250506020611936858286016110f3565b9150509250929050565b60008115159050919050565b61195581611940565b82525050565b6000602082019050611970600083018461194c565b92915050565b6000819050919050565b600061199b61199661199184610fb1565b611976565b610fb1565b9050919050565b60006119ad82611980565b9050919050565b60006119bf826119a2565b9050919050565b6119cf816119b4565b82525050565b60006020820190506119ea60008301846119c6565b92915050565b6119f9816110d2565b82525050565b6000602082019050611a1460008301846119f0565b92915050565b6000819050919050565b6000611a3f611a3a611a3584610fb1565b611a1a565b610fb1565b9050919050565b6000611a5182611a24565b9050919050565b6000611a6382611a46565b9050919050565b611a7381611a58565b82525050565b6000602082019050611a8e6000830184611a6a565b92915050565b611a9d81611940565b8114611aa857600080fd5b50565b600081359050611aba81611a94565b92915050565b6000606082019050611ad56000830186611217565b611ae2602083018561126e565b611aef604083018461194c565b949350505050565b6000602082019050611b0c6000830184611217565b92915050565b600060208284031215611b2857611b27610ee4565b5b6000611b36848285016110f3565b91505092915050565b6000602082019050611b54600083018461126e565b92915050565b600060208284031215611b7057611b6f610ee4565b5b6000611b7e84828501611aab565b91505092915050565b600081519050611b9681610fe3565b92915050565b6000611ba782611a24565b9050919050565b6000611bb982611b9c565b9050919050565b6000611bcb82611bae565b9050919050565b611bdb81611bc0565b82525050565b6000602082019050611bf66000830184611bd2565b92915050565b7f4c656e677468206d69736d617463680000000000000000000000000000000000600082015250565b6000611c32600f836112d0565b9150611c3d82611bfc565b602082019050919050565b60006020820190508181036000830152611c6181611c25565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b611ca181610fd1565b82525050565b611cb0816110d2565b82525050565b6000604082019050611ccb6000830185611c98565b611cd86020830184611ca7565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000611d19826110d2565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415611d4c57611d4b611cdf565b5b600182019050919050565b6000611d62826110d2565b9150611d6d836110d2565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115611da257611da1611cdf565b5b82820190509291505056fea2646970667358221220f3b5e7e8e5b5a8b5e5b5a8b5e5b5a8b5e5b5a8b5e5b5a8b5e5b5a8b5e5b5a8b564736f6c63430008090033";

async function deployContract() {
  console.log('🚀 开始部署 Monad 卡牌游戏合约...\n');
  
  try {
    // 检查环境变量
    if (!process.env.PRIVATE_KEY) {
      throw new Error('请在 .env 文件中设置 PRIVATE_KEY');
    }
    
    // 连接到 Monad 测试网
    console.log(`📡 连接到 ${MONAD_TESTNET_CONFIG.name}...`);
    const provider = new ethers.JsonRpcProvider(MONAD_TESTNET_CONFIG.rpcUrl);
    
    // 创建钱包
    const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
    console.log(`💰 部署账户: ${wallet.address}`);
    
    // 检查余额
    const balance = await provider.getBalance(wallet.address);
    console.log(`💎 账户余额: ${ethers.formatEther(balance)} MONAD`);
    
    if (balance === 0n) {
      console.log('\n⚠️  警告: 账户余额为 0');
      console.log('请从 Monad 测试网水龙头获取测试币');
      console.log('水龙头地址: https://testnet-faucet.monad.network');
      return;
    }
    
    // 估算 Gas
    console.log('\n⛽ 估算 Gas 费用...');
    const gasPrice = await provider.getFeeData();
    console.log(`当前 Gas 价格: ${ethers.formatUnits(gasPrice.gasPrice, 'gwei')} gwei`);
    
    // 创建合约工厂
    const contractFactory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, wallet);
    
    // 估算部署 Gas
    const estimatedGas = await provider.estimateGas({
      data: CONTRACT_BYTECODE
    });
    const deploymentCost = estimatedGas * gasPrice.gasPrice;
    console.log(`预估部署成本: ${ethers.formatEther(deploymentCost)} MONAD`);
    
    // 部署合约
    console.log('\n📝 部署合约中...');
    const contract = await contractFactory.deploy({
      gasLimit: estimatedGas * 120n / 100n // 增加 20% 余量
    });
    
    console.log(`🔗 合约地址: ${contract.target}`);
    console.log(`📄 交易哈希: ${contract.deploymentTransaction().hash}`);
    console.log('\n⏳ 等待交易确认...');
    
    // 等待部署完成
    const receipt = await contract.deploymentTransaction().wait(2); // 等待 2 个区块确认
    console.log(`✅ 合约已成功部署！`);
    console.log(`🔍 区块高度: ${receipt.blockNumber}`);
    console.log(`⛽ 实际 Gas 使用: ${receipt.gasUsed.toString()}`);
    
    // 保存部署信息
    const deploymentInfo = {
      contractAddress: contract.target,
      deployer: wallet.address,
      network: MONAD_TESTNET_CONFIG.name,
      chainId: MONAD_TESTNET_CONFIG.chainId,
      timestamp: new Date().toISOString(),
      transactionHash: contract.deploymentTransaction().hash,
      blockNumber: receipt.blockNumber,
      gasUsed: receipt.gasUsed.toString(),
      deploymentCost: ethers.formatEther(receipt.gasUsed * gasPrice.gasPrice),
      explorer: `${MONAD_TESTNET_CONFIG.explorer}/address/${contract.target}`
    };
    
    // 写入文件
    fs.writeFileSync(
      path.join(__dirname, 'deployment-info-v2.json'),
      JSON.stringify(deploymentInfo, null, 2)
    );
    
    console.log('\n📊 部署信息已保存到 deployment-info-v2.json');
    console.log(`\n🌐 在浏览器中查看:`);
    console.log(`${deploymentInfo.explorer}`);
    
    // 验证合约
    console.log('\n🔍 验证合约功能...');
    
    // 测试基本功能
    const contractBalance = await contract.getContractBalance();
    console.log(`合约余额: ${ethers.formatEther(contractBalance)} MONAD`);
    
    const playerCount = await contract.getPlayerCount();
    console.log(`玩家数量: ${playerCount}`);
    
    const owner = await contract.owner();
    console.log(`合约所有者: ${owner}`);
    
    console.log('\n🎉 部署完成！合约已准备就绪。');
    
    // 生成前端配置
    const frontendConfig = `
// 自动生成的配置文件
export const CONTRACT_ADDRESS = '${contract.target}';
export const CHAIN_ID = ${MONAD_TESTNET_CONFIG.chainId};
export const NETWORK_NAME = '${MONAD_TESTNET_CONFIG.name}';
export const RPC_URL = '${MONAD_TESTNET_CONFIG.rpcUrl}';
export const EXPLORER_URL = '${MONAD_TESTNET_CONFIG.explorer}';
export const DEPLOYMENT_BLOCK = ${receipt.blockNumber};
`;
    
    fs.writeFileSync(
      path.join(__dirname, 'src/config/contractConfig.js'),
      frontendConfig
    );
    
    console.log('\n📄 前端配置文件已更新');
    
  } catch (error) {
    console.error('\n❌ 部署失败:', error.message);
    
    if (error.code === 'INSUFFICIENT_FUNDS') {
      console.log('\n💡 提示: 账户余额不足，请获取测试币');
    } else if (error.code === 'NETWORK_ERROR') {
      console.log('\n💡 提示: 网络连接失败，请检查 RPC URL');
    } else if (error.code === 'INVALID_ARGUMENT') {
      console.log('\n💡 提示: 参数无效，请检查私钥格式');
    }
    
    process.exit(1);
  }
}

// 运行部署
if (require.main === module) {
  deployContract();
}

module.exports = { deployContract };