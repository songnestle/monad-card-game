import { ethers } from 'ethers';
import dotenv from 'dotenv';
import fs from 'fs';

dotenv.config();

// MonadCardGame合约字节码
const CONTRACT_BYTECODE = "0x608060405234801561000f575f80fd5b50662386f26fc100006002556201518060035533600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610e468061006e5f395ff3fe60806040526004361061011e575f3560e01c8063a5393bd1116100a5578063d7c01c0e11610074578063d7c01c0e146103a3578063e2dc85dc146103cd578063f340fa01146103f5578063f3d0e9e214610411578063f6d361cc1461043b5761011e565b8063a5393bd1146102db578063a9059cbb14610305578063c59b6c1814610341578063d3121b8f1461036b5761011e565b80633ba0b9a9116100f15780633ba0b9a91461020d57806370a08231146102375780638da5cb5b1461027357806394b0050d1461029d57806395d89b41146102b15761011e565b806306fdde0314610122578063095ea7b31461014c57806318160ddd146101885780632e1a7d4d146101b2575b5f80fd5b34801561012d575f80fd5b50610136610465565b6040516101439190610a4d565b60405180910390f35b348015610157575f80fd5b50610172600480360381019061016d9190610afe565b6104a1565b60405161017f9190610b56565b60405180910390f35b348015610193575f80fd5b5061019c6104b7565b6040516101a99190610b7e565b60405180910390f35b3480156101bd575f80fd5b506101d860048036038101906101d39190610b97565b6104bd565b005b3480156101e8575f80fd5b5061020360048036038101906101fe9190610bc2565b610627565b005b348015610218575f80fd5b506102216106e7565b60405161022e9190610b7e565b60405180910390f35b348015610242575f80fd5b5061025d60048036038101906102589190610bc2565b6106ed565b60405161026a9190610b7e565b60405180910390f35b34801561027e575f80fd5b50610287610704565b6040516102949190610bfc565b60405180910390f35b6102b560048036038101906102b09190610d4e565b610729565b005b3480156102bc575f80fd5b506102c5610904565b6040516102d29190610a4d565b60405180910390f35b3480156102e6575f80fd5b506102ef610940565b6040516102fc9190610b7e565b60405180910390f35b348015610310575f80fd5b5061032b60048036038101906103269190610afe565b610946565b6040516103389190610b56565b60405180910390f35b34801561034c575f80fd5b5061035561095c565b6040516103629190610b7e565b60405180910390f35b348015610376575f80fd5b50610391600480360381019061038c9190610bc2565b610962565b60405161039e96959493929190610dde565b60405180910390f35b3480156103ae575f80fd5b506103b7610a0f565b6040516103c49190610b7e565b60405180910390f35b3480156103d8575f80fd5b506103f360048036038101906103ee9190610bc2565b610a15565b005b61040f600480360381019061040a9190610bc2565b610a2e565b005b34801561041c575f80fd5b50610425610a40565b6040516104329190610b7e565b60405180910390f35b348015610446575f80fd5b5061044f610a46565b60405161045c9190610b7e565b60405180910390f35b60405180604001604052806010815260200160cf4d6f6e616420436172642047616d6560801b81525081565b5f6104ad338484610a4c565b6001905092915050565b60055481565b8060065f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054101561053e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161053590610e94565b60405180910390fd5b8060065f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546105899190610edf565b925050819055508060055f8282546105a19190610edf565b925050819055503373ffffffffffffffffffffffffffffffffffffffff166108fc8290811502906040515f60405180830381858888f193505050501580156105eb573d5f803e3d5ffd5b507f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a942436433826040516106239291906a48756e7465724b696e676360a81b815260a01b60200182015250565b60405180910390a150565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146106b7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106ae90610f5c565b60405180910390fd5b5f600854146106e4576106e3600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16610962565b5b50565b60025481565b6006602052805f5260405f205f915090505481565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60058151146107525760405162461bcd60e51b815260040161074990606560f81b81525060040160405180910390fd5b6002543410156107765760405162461bcd60e51b815260040161074990606560f81b81525060040160405180910390fd5b5f600854146107a3576107a2600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16610962565b5b60075f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2060010154156107ee575f80fd5b60405180606001604052808281526020014281526020016001151581525060075f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f820151815f0190816108689190611116565b50602082015181600101556040820151816002015f6101000a81548160ff02191690831515021790555090505034600860008282546108a791906111e1565b925050819055507f3373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fc1e13b2e57b05ec6ab7ae72a223cc409f0e943e56d40e4cd9a1bf7c9937a8f503483604051610900939291906111f5565b60405180910390a250565b60405180604001604052806004815260200160e3808d60e01b81525081565b60015481565b5f610952338484610bfd565b6001905092915050565b60035481565b60075f8273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f0180546109ad90610fa7565b80601f01602080910402602001604051908101604052809291908181526020018280546109da90610fa7565b8015610a295780601f106109fc57610100808354040283529160200191610a29565b820191905f5260205f20905b815481529060010190602001808311610a0857829003601f168201915b505050505090565b60065f8273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205481565b333273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610aaf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610aa690611273565b60405180910390fd5b60085f815480929190610ac1906112b3565b91905055503460015f828254610ad791906111e1565b925050819055503460065f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254610b2a91906111e1565b925050819055507fae50c89c5f0e20c1e0b3446e5f64a9358e8e7624e8a0e944ac00e993f2b3fa163433604051610b6a9291906a48756e7465724b696e676360a81b815260a01b60200182015250565b60405180910390a150565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610beb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610be290611330565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610c59576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c5090611398565b60405180910390fd5b8060065f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20541015610cd9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cd090611400565b60405180910390fd5b8060065f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254610d249190610edf565b925050819055508060065f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254610d7791906111e1565b925050819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610ddb9190610b7e565b60405180910390a3505050565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610e2f5780600560008282540382505081905550610ea8565b8060065f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20541015610e9e5781815f5260065f5260405f205f828254610e8f91906111e1565b92505081905550610ea8565b5f610ea857600190505b5050565b5f82825260208201905092915050565b50565b5f610ec75f83610eac565b9150610ed282610eb6565b5f82019050919050565b5f819050919050565b5f610ef982610edc565b9150610f0483610edc565b9250828203905081811115610f1c57610f1b61141f565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610f6757607f821691505b602082108103610f7a57610f79610f22565b5b50919050565b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b610fa182610f88565b810181811067ffffffffffffffff82111715610fc057610fbf61144c565b5b80604052505050565b5f610fd3610a44565b9050610fdf8282610f98565b919050565b5f67ffffffffffffffff821115610ffe57610ffd61144c565b5b602082029050602081019050919050565b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61103c82611013565b9050919050565b61104c81611032565b8114611056575f80fd5b50565b5f8135905061106781611043565b92915050565b5f61107f61107a84610fe4565b610fc9565b905080838252602082019050602084028301858111156110a2576110a161100f565b5b835b818110156110cb57806110b78882611059565b8452602084019350506020810190506110a4565b5050509392505050565b5f82601f8301126110e9576110e8610f84565b5b81356110f984826020860161106d565b91505092915050565b5f81359050611110816113f7565b92915050565b5f8151905061112481611043565b92915050565b5f67ffffffffffffffff8211156111445761114361144c565b5b61114d82610f88565b9050602081019050919050565b5f61116c6111678461112a565b610fc9565b90508281526020810184848401111561118857611187610f84565b5b611193848285611479565b509392505050565b5f82601f8301126111af576111ae610f84565b5b81516111bf84826020860161115a565b91505092915050565b5f815190506111d6816113f7565b92915050565b5f819050919050565b5f6111f983610edc565b915061120483610edc565b925082820190508082111561121c5761121b61141f565b5b92915050565b61122b81610edc565b82525050565b5f6060820190506112445f830186611222565b6112516020830185611222565b61125e6040830184611222565b949350505050565b5f82825260208201905092915050565b7f436f6e7472616374206e6f7420616c6c6f7765640000000000000000000000005f82015250565b5f6112aa601483611266565b91506112b582611276565b602082019050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6112f782610edc565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036113295761132861141f565b5b600182019050919050565b7f4d6f6e616420476d653a20617070726f7665207a65726f2061646472657373005f82015250565b5f611368601f83611266565b915061137382611334565b602082019050919050565b7f4d6f6e616420476d653a207472616e73666572207a65726f20616464726573735f82015250565b5f6113b2602083611266565b91506113bd8261137e565b602082019050919050565b7f4d6f6e616420476d653a20696e73756666696369656e742062616c616e6365005f82015250565b5f6113fc601f83611266565b9150611407826113c8565b602082019050919050565b5f81905092915050565b82818337505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b5f819050919050565b5f8115159050919050565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f82825260208201905092915050565b5f6114c182611479565b6114cb81856114a5565b93506114db818560208601611495565b6114e481610f88565b840191505092915050565b5f6020820190508181035f83015261150781846114b6565b905092915050565b5f8115159050919050565b6115238161150f565b82525050565b5f60208201905061153c5f83018461151a565b92915050565b61154b81610edc565b82525050565b5f6020820190506115645f830184611542565b92915050565b5f6020828403121561157f5761157e610f80565b5b5f61158c84828501611102565b91505092915050565b5f602082840312156115aa576115a9610f80565b5b5f6115b784828501611059565b91505092915050565b5f80604083850312156115d6576115d5610f80565b5b5f6115e385828601611059565b92505060206115f485828601611102565b9150509250929050565b5f6020828403121561161357611612610f80565b5b5f82013567ffffffffffffffff81111561163057611625610f84565b5b61163c848285016110d5565b91505092915050565b61164e81611032565b82525050565b5f6020820190506116675f830184611645565b92915050565b5f6116788385611266565b935061168583858461141c565b61168e83610f88565b840190509392505050565b5f6020820190508181035f8301526116b281848661166d565b90509392505050565b5f6060820190506116ce5f830186611542565b6116db6020830185611542565b6116e8604083018461151a565b949350505050565b5f6040820190506117035f830185611645565b6117106020830184611542565b939250505056fea2646970667358221220f8e8a89c2f8f8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e64736f6c63430008140033";

// MonadCardGame合约ABI
const CONTRACT_ABI = [
  {
    "inputs": [
      {
        "internalType": "string[]",
        "name": "cardSymbols",
        "type": "string[]"
      }
    ],
    "name": "submitHand",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "player",
        "type": "address"
      }
    ],
    "name": "getPlayerHand",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "ENTRY_FEE",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "owner",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

async function deployContract() {
  console.log('🚀 准备部署MonadCardGame合约到Monad测试网...\n');
  
  if (!process.env.PRIVATE_KEY) {
    console.error('❌ 错误: 请在.env文件中设置PRIVATE_KEY');
    console.log('   示例: PRIVATE_KEY=your_private_key_here');
    return;
  }
  
  try {
    // 1. 连接到Monad测试网
    const provider = new ethers.JsonRpcProvider('https://testnet-rpc.monad.xyz');
    console.log('✅ 已连接到Monad测试网');
    
    // 2. 创建钱包
    const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
    console.log('👛 部署钱包地址:', wallet.address);
    
    // 3. 检查余额
    const balance = await provider.getBalance(wallet.address);
    console.log('💰 钱包余额:', ethers.formatEther(balance), 'MONAD');
    
    if (balance < ethers.parseEther('0.1')) {
      console.error('❌ 余额不足！需要至少0.1 MONAD来部署合约');
      console.log('   请访问 https://faucet.monad.xyz 获取测试币');
      return;
    }
    
    // 4. 部署合约
    console.log('\n📝 部署合约中...');
    const factory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, wallet);
    const contract = await factory.deploy();
    
    console.log('⏳ 等待交易确认...');
    console.log('📍 交易哈希:', contract.deploymentTransaction().hash);
    
    await contract.waitForDeployment();
    
    const contractAddress = await contract.getAddress();
    console.log('\n✅ 合约部署成功！');
    console.log('📍 合约地址:', contractAddress);
    
    // 5. 验证合约
    console.log('\n🔍 验证合约...');
    const deployedContract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);
    
    const entryFee = await deployedContract.ENTRY_FEE();
    const owner = await deployedContract.owner();
    
    console.log('  - ENTRY_FEE:', ethers.formatEther(entryFee), 'ETH');
    console.log('  - Owner:', owner);
    
    // 6. 保存部署信息
    const deploymentInfo = {
      contractAddress: contractAddress,
      deployer: wallet.address,
      network: 'Monad Testnet',
      chainId: 10143,
      timestamp: new Date().toISOString(),
      transactionHash: contract.deploymentTransaction().hash,
      entryFee: ethers.formatEther(entryFee) + ' ETH'
    };
    
    fs.writeFileSync('deployment-info.json', JSON.stringify(deploymentInfo, null, 2));
    console.log('\n📄 部署信息已保存到 deployment-info.json');
    
    // 7. 更新前端配置
    console.log('\n📱 请更新前端代码中的合约地址:');
    console.log(`
// 在 src/UltimateMonadApp.jsx 中更新:
const MONAD_CARD_GAME_CONTRACT = {
  address: '${contractAddress}',
  abi: [...] // 保持现有ABI不变
};
`);
    
    // 8. 更新.env文件
    console.log('同时更新 .env 文件:');
    console.log(`VITE_CONTRACT_ADDRESS=${contractAddress}`);
    
    console.log('\n🎉 部署完成！');
    console.log('📝 下一步：');
    console.log('1. 更新前端代码中的合约地址');
    console.log('2. 更新.env文件中的VITE_CONTRACT_ADDRESS');
    console.log('3. 重新启动前端应用');
    
  } catch (error) {
    console.error('\n❌ 部署失败:', error.message);
    if (error.code === 'INSUFFICIENT_FUNDS') {
      console.log('💡 提示: 请确保钱包有足够的MONAD测试币');
      console.log('   访问 https://faucet.monad.xyz 获取测试币');
    }
  }
}

deployContract();