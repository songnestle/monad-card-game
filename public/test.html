<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’±åŒ…å†²çªæµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ´ Monadå¡ç‰Œæ¸¸æˆ - é’±åŒ…å†²çªè¯Šæ–­</h1>
    
    <div class="test-section">
        <h2>é’±åŒ…æ£€æµ‹çŠ¶æ€</h2>
        <div id="wallet-status"></div>
        <button onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
    </div>
    
    <div class="test-section">
        <h2>é”™è¯¯æ—¥å¿—</h2>
        <div id="error-log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="test-section">
        <h2>åŸå§‹è°ƒè¯•ä¿¡æ¯</h2>
        <pre id="debug-info"></pre>
    </div>

    <script>
        let errorLog = [];
        
        // æ•è·æ‰€æœ‰é”™è¯¯
        window.onerror = function(message, source, lineno, colno, error) {
            if (source && source.includes('chrome-extension://')) {
                return; // å¿½ç•¥æ‰©å±•é”™è¯¯
            }
            
            errorLog.push({
                type: 'Error',
                message: message,
                source: source,
                line: lineno,
                timestamp: new Date().toISOString()
            });
            updateErrorLog();
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason?.message?.includes('MetaMask')) {
                event.preventDefault();
                return;
            }
            
            errorLog.push({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || event.reason,
                timestamp: new Date().toISOString()
            });
            updateErrorLog();
        });
        
        function updateErrorLog() {
            const logDiv = document.getElementById('error-log');
            logDiv.innerHTML = errorLog.map(err => 
                `<div class="error">
                    <strong>${err.type}</strong> (${err.timestamp})<br>
                    ${err.message}
                    ${err.source ? `<br><small>Source: ${err.source}:${err.line}</small>` : ''}
                </div>`
            ).join('');
        }
        
        function clearLog() {
            errorLog = [];
            updateErrorLog();
        }
        
        function detectWallets() {
            const result = {
                hasWindow: typeof window !== 'undefined',
                hasEthereum: !!window.ethereum,
                ethereumProperties: {},
                providers: [],
                conflicts: []
            };
            
            try {
                if (window.ethereum) {
                    result.ethereumProperties = {
                        isMetaMask: !!window.ethereum.isMetaMask,
                        isNightly: !!window.ethereum.isNightly,
                        isCoinbaseWallet: !!window.ethereum.isCoinbaseWallet,
                        hasProviders: !!window.ethereum.providers,
                        providersCount: window.ethereum.providers?.length || 0
                    };
                    
                    if (window.ethereum.providers) {
                        result.providers = window.ethereum.providers.map((p, i) => ({
                            index: i,
                            isMetaMask: !!p.isMetaMask,
                            isNightly: !!p.isNightly,
                            isCoinbaseWallet: !!p.isCoinbaseWallet
                        }));
                    }
                }
                
                // æ£€æµ‹å†²çª
                if (window.ethereum?.isNightly && window.ethereum?.isMetaMask) {
                    result.conflicts.push('Nightlyé’±åŒ…è¦†ç›–äº†MetaMaskå±æ€§');
                }
                
                if (window.__metamask) {
                    result.conflicts.push('æ£€æµ‹åˆ°MetaMaskå¤‡ä»½å¼•ç”¨');
                }
                
                if (window.__ethereum_backup) {
                    result.conflicts.push('æ£€æµ‹åˆ°Ethereumå¤‡ä»½å¼•ç”¨');
                }
                
            } catch (error) {
                result.error = error.message;
            }
            
            return result;
        }
        
        function refreshStatus() {
            const status = detectWallets();
            const statusDiv = document.getElementById('wallet-status');
            
            let html = '';
            
            if (status.hasEthereum) {
                html += '<div class="success">âœ… æ£€æµ‹åˆ°window.ethereum</div>';
            } else {
                html += '<div class="error">âŒ æœªæ£€æµ‹åˆ°window.ethereum</div>';
            }
            
            if (status.ethereumProperties.isMetaMask) {
                html += '<div class="success">âœ… MetaMaskå¯ç”¨</div>';
            } else {
                html += '<div class="warning">âš ï¸ MetaMaskä¸å¯ç”¨</div>';
            }
            
            if (status.ethereumProperties.isNightly) {
                html += '<div class="warning">âš ï¸ Nightlyé’±åŒ…æ´»è·ƒ</div>';
            }
            
            if (status.providers.length > 0) {
                html += `<div class="status">ğŸ“¦ æ£€æµ‹åˆ°${status.providers.length}ä¸ªæä¾›è€…:</div>`;
                status.providers.forEach(p => {
                    const types = [];
                    if (p.isMetaMask) types.push('MetaMask');
                    if (p.isNightly) types.push('Nightly');
                    if (p.isCoinbaseWallet) types.push('Coinbase');
                    html += `<div class="status">- æä¾›è€… ${p.index}: ${types.join(', ') || 'æœªçŸ¥'}</div>`;
                });
            }
            
            if (status.conflicts.length > 0) {
                html += '<div class="error">âš ï¸ æ£€æµ‹åˆ°å†²çª:</div>';
                status.conflicts.forEach(conflict => {
                    html += `<div class="error">- ${conflict}</div>`;
                });
            }
            
            if (status.error) {
                html += `<div class="error">âŒ æ£€æµ‹é”™è¯¯: ${status.error}</div>`;
            }
            
            statusDiv.innerHTML = html;
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            document.getElementById('debug-info').textContent = JSON.stringify(status, null, 2);
        }
        
        async function testConnection() {
            try {
                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…');
                }
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length > 0) {
                    document.getElementById('wallet-status').innerHTML += 
                        `<div class="success">âœ… è¿æ¥æˆåŠŸ: ${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}</div>`;
                } else {
                    throw new Error('æœªè·å–åˆ°è´¦æˆ·');
                }
                
            } catch (error) {
                document.getElementById('wallet-status').innerHTML += 
                    `<div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(refreshStatus, 1000); // å»¶è¿Ÿ1ç§’ç­‰å¾…æ‰©å±•åŠ è½½
        });
    </script>
</body>
</html>